<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë¼ì˜¨ AI ë¹„ì„œ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0a0f;--bg2:#12121a;--bg3:#1a1a28;--bg4:#22223a;
  --text:#e8e8f0;--text2:#9999aa;--text3:#666678;
  --accent:#FF6B35;--accent2:#F7C948;--accent-bg:rgba(255,107,53,.1);
  --glass:rgba(18,18,26,.75);--glass-border:rgba(255,255,255,.06);
  --sidebar-w:260px;--radius:12px;--radius-sm:8px;
}
html,body{height:100%;overflow:hidden}
body{
  font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);color:var(--text);font-size:15px;line-height:1.7;
  display:flex;
}
/* â”€â”€ Scrollbar â”€â”€ */
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text3)}

/* â”€â”€ Sidebar â”€â”€ */
.sidebar{
  width:var(--sidebar-w);height:100vh;flex-shrink:0;
  background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-right:1px solid var(--glass-border);
  display:flex;flex-direction:column;transition:margin-left .3s ease;
  z-index:100;position:relative;
}
.sidebar.collapsed{margin-left:calc(var(--sidebar-w)*-1)}
.sidebar-header{padding:20px 16px 12px;display:flex;align-items:center;gap:10px}
.sidebar-logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.sidebar-title{font-size:16px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sidebar-subtitle{font-size:11px;color:var(--text3);margin-top:-2px}

.sidebar-section{padding:0 12px;margin-top:16px}
.sidebar-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;padding:0 8px 6px;font-weight:600}

.mode-btn{
  display:flex;align-items:center;gap:10px;width:100%;padding:10px 12px;
  border:none;background:transparent;color:var(--text2);cursor:pointer;
  border-radius:var(--radius-sm);font-size:14px;text-align:left;
  transition:all .15s;font-family:inherit;
}
.mode-btn:hover{background:var(--bg3);color:var(--text)}
.mode-btn.active{background:var(--accent-bg);color:var(--accent);font-weight:600}
.mode-btn .mode-icon{font-size:18px;width:24px;text-align:center;flex-shrink:0}

.sidebar-divider{height:1px;background:var(--glass-border);margin:16px 12px}

/* History */
.history-section{flex:1;overflow-y:auto;padding:0 12px;min-height:0}
.history-item{
  display:flex;align-items:center;gap:8px;padding:8px 12px;
  border-radius:var(--radius-sm);cursor:pointer;color:var(--text2);
  font-size:13px;transition:background .15s;overflow:hidden;
  text-overflow:ellipsis;white-space:nowrap;
}
.history-item:hover{background:var(--bg3);color:var(--text)}
.history-item .hi-icon{flex-shrink:0;font-size:14px}
.history-item .hi-text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.history-item .hi-del{
  margin-left:auto;opacity:0;background:none;border:none;color:var(--text3);
  cursor:pointer;font-size:14px;padding:2px;flex-shrink:0;
}
.history-item:hover .hi-del{opacity:1}
.history-empty{padding:12px;color:var(--text3);font-size:12px;text-align:center}

/* Profile card */
.profile-card{
  margin:12px;padding:14px;background:var(--bg3);border-radius:var(--radius);
  border:1px solid var(--glass-border);flex-shrink:0;
}
.profile-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.profile-title{font-size:13px;font-weight:600;color:var(--text)}
.profile-level{font-size:11px;color:var(--accent);font-weight:600}
.xp-bar{height:4px;background:var(--bg);border-radius:2px;overflow:hidden}
.xp-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:2px;transition:width .5s ease}
.profile-xp-text{font-size:10px;color:var(--text3);text-align:right;margin-top:3px}
.profile-badges{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.profile-badge{font-size:14px;cursor:default}

/* â”€â”€ Main â”€â”€ */
.main{flex:1;display:flex;flex-direction:column;min-width:0;height:100vh}

/* Top bar */
.topbar{
  padding:12px 20px;display:flex;align-items:center;gap:12px;
  border-bottom:1px solid var(--glass-border);flex-shrink:0;
  background:var(--glass);backdrop-filter:blur(20px);
}
.topbar-toggle{
  background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer;
  padding:4px;border-radius:6px;transition:color .15s;
}
.topbar-toggle:hover{color:var(--text)}
.topbar-mode{font-size:15px;font-weight:600;flex:1}
.topbar-new{
  background:var(--bg3);border:1px solid var(--glass-border);color:var(--text2);
  padding:6px 14px;border-radius:var(--radius-sm);cursor:pointer;font-size:13px;
  font-family:inherit;transition:all .15s;display:flex;align-items:center;gap:6px;
}
.topbar-new:hover{background:var(--bg4);color:var(--text)}
.topbar-kbd{font-size:10px;color:var(--text3);background:var(--bg);padding:2px 5px;border-radius:4px}

/* Messages */
.messages{flex:1;overflow-y:auto;padding:24px 20px;min-height:0}
.messages-inner{max-width:1100px;margin:0 auto}
.msg{margin-bottom:20px;animation:msgIn .3s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.msg-bot{display:flex;gap:12px;align-items:flex-start}
.msg-avatar{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.msg-content{
  background:var(--bg2);border:1px solid var(--glass-border);
  border-radius:var(--radius) var(--radius) var(--radius) 4px;
  padding:14px 18px;max-width:calc(100% - 50px);color:var(--text);
  font-size:14px;line-height:1.7;
}
.msg-user{display:flex;justify-content:flex-end}
.msg-user .msg-content{
  background:linear-gradient(135deg,var(--accent),#e85d2a);color:white;
  border:none;border-radius:var(--radius) var(--radius) 4px var(--radius);
  max-width:85%;
}
/* Markdown */
.msg-content h1,.msg-content h2,.msg-content h3{color:var(--accent);margin:12px 0 6px;font-weight:700}
.msg-content h1{font-size:17px}
.msg-content h2{font-size:15px}
.msg-content h3{font-size:14px}
.msg-content strong{color:var(--text);font-weight:600}
.msg-content ul,.msg-content ol{padding-left:20px;margin:6px 0}
.msg-content li{margin:3px 0}
.msg-content table{border-collapse:collapse;width:100%;margin:10px 0;font-size:13px}
.msg-content th{background:var(--bg3);border:1px solid var(--bg4);padding:6px 10px;text-align:left;font-weight:600;color:var(--accent)}
.msg-content td{border:1px solid var(--bg4);padding:6px 10px}
.msg-content code{background:var(--bg3);padding:2px 6px;border-radius:4px;font-size:13px}
.msg-content pre{background:var(--bg3);padding:12px;border-radius:var(--radius-sm);overflow-x:auto;margin:8px 0}
.msg-content pre code{background:none;padding:0}
.msg-content .score-display{font-size:28px;font-weight:700;margin:8px 0}
.msg-content .xp-inline{margin-top:12px;padding:10px;background:var(--bg3);border-radius:var(--radius-sm);font-size:12px}
.msg-content .xp-inline .xp-bar-inline{height:4px;background:var(--bg);border-radius:2px;overflow:hidden;margin-top:6px}
.msg-content .xp-inline .xp-fill-inline{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:2px;transition:width .5s}

/* Loading */
.msg-loading .msg-content{background:var(--bg2);border:1px solid var(--glass-border)}
.spinner{width:16px;height:16px;border:2px solid var(--bg4);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-inner{display:flex;align-items:center;gap:8px;color:var(--text2);font-size:13px}
.progress-bar{height:3px;background:var(--bg);border-radius:2px;margin-top:8px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:2px;transition:width .5s}
.loading-tip{font-size:11px;color:var(--accent);margin-top:6px}
.loading-elapsed{font-size:10px;color:var(--text3);margin-top:2px}

/* Welcome */
.welcome{text-align:center;padding:60px 20px}
.welcome-emoji{font-size:48px;margin-bottom:16px}
.welcome h2{font-size:22px;font-weight:700;margin-bottom:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.welcome p{color:var(--text2);font-size:14px;max-width:600px;margin:0 auto}
.welcome-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:24px;max-width:700px;margin-left:auto;margin-right:auto}
.welcome-card{
  background:var(--bg2);border:1px solid var(--glass-border);border-radius:var(--radius);
  padding:14px;cursor:pointer;text-align:left;transition:all .15s;
}
.welcome-card:hover{border-color:var(--accent);background:var(--accent-bg)}
.welcome-card .wc-icon{font-size:20px;margin-bottom:6px}
.welcome-card .wc-title{font-size:13px;font-weight:600;color:var(--text)}
.welcome-card .wc-desc{font-size:11px;color:var(--text3);margin-top:2px}

/* Idea cards */
.idea-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin:12px 0}
.idea-card{
  background:var(--bg3);border:1px solid var(--glass-border);border-radius:var(--radius);
  padding:14px;cursor:pointer;transition:all .15s;
}
.idea-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.idea-card .ic-num{font-size:11px;color:var(--accent);font-weight:600}
.idea-card .ic-name{font-size:14px;font-weight:600;margin:4px 0}
.idea-card .ic-desc{font-size:12px;color:var(--text2);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.idea-card .ic-source{font-size:10px;color:var(--text3);margin-top:6px}
.idea-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
.idea-action-btn{
  border:none;border-radius:6px;padding:5px 10px;font-size:11px;cursor:pointer;
  font-family:inherit;font-weight:500;transition:opacity .15s;color:white;
}
.idea-action-btn:hover{opacity:.85}

/* â”€â”€ Input area â”€â”€ */
.input-area{
  padding:16px 20px;border-top:1px solid var(--glass-border);flex-shrink:0;
  background:var(--glass);backdrop-filter:blur(20px);
}
.input-inner{max-width:1100px;margin:0 auto}
.file-badge{
  display:none;align-items:center;gap:6px;padding:6px 12px;margin-bottom:8px;
  background:var(--accent-bg);border-radius:var(--radius-sm);font-size:12px;color:var(--accent);
}
.file-badge.visible{display:inline-flex}
.file-badge button{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px}
.drop-zone{
  display:none;padding:20px;border:2px dashed var(--accent);border-radius:var(--radius);
  text-align:center;color:var(--accent);font-size:13px;margin-bottom:8px;
  background:var(--accent-bg);
}
.drop-zone.active{display:block}
.input-row{display:flex;gap:10px;align-items:flex-end}
.input-wrap{
  flex:1;position:relative;background:var(--bg2);border:1px solid var(--glass-border);
  border-radius:var(--radius);display:flex;align-items:flex-end;transition:border-color .15s;
}
.input-wrap:focus-within{border-color:var(--accent)}
.input-wrap textarea{
  flex:1;background:none;border:none;color:var(--text);font-size:14px;
  padding:12px 14px;resize:none;outline:none;font-family:inherit;line-height:1.5;
  min-height:24px;max-height:120px;
}
.input-wrap textarea::placeholder{color:var(--text3)}
.input-btns{display:flex;gap:2px;padding:6px 8px 6px 0;align-items:flex-end}
.pdf-btn{
  background:none;border:none;color:var(--text3);font-size:20px;cursor:pointer;
  padding:4px;border-radius:6px;transition:color .15s;
}
.pdf-btn:hover,.pdf-btn.has-file{color:var(--accent)}
.send-btn{
  width:40px;height:40px;border-radius:var(--radius-sm);
  background:linear-gradient(135deg,var(--accent),#e85d2a);
  border:none;cursor:pointer;color:white;font-size:18px;
  display:flex;align-items:center;justify-content:center;
  transition:opacity .15s;flex-shrink:0;
}
.send-btn:disabled{opacity:.4;cursor:not-allowed}
.send-btn:hover:not(:disabled){opacity:.9}

/* Cmd+K modal */
.cmd-modal-overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;
  align-items:flex-start;justify-content:center;padding-top:20vh;
}
.cmd-modal-overlay.open{display:flex}
.cmd-modal{
  background:var(--bg2);border:1px solid var(--glass-border);border-radius:var(--radius);
  width:380px;max-width:90vw;overflow:hidden;animation:modalIn .15s ease;
}
@keyframes modalIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:none}}
.cmd-modal-header{padding:12px 16px;border-bottom:1px solid var(--glass-border);font-size:13px;color:var(--text3)}
.cmd-modal .mode-btn{padding:12px 16px;border-radius:0}
.cmd-modal .mode-btn:hover{background:var(--bg3)}

/* â”€â”€ Feedback bar (evaluate / improve ëª¨ë“œ) â”€â”€ */
.feedback-bar{
  margin-top:14px;padding-top:12px;
  border-top:1px solid var(--glass-border);
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
}
.feedback-label{font-size:12px;color:var(--text3);white-space:nowrap}
.fb-btn{
  background:var(--bg3);border:1px solid var(--glass-border);
  color:var(--text2);padding:5px 16px;border-radius:20px;
  cursor:pointer;font-size:13px;font-family:inherit;
  transition:all .15s;
}
.fb-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-bg)}
.fb-btn:disabled{opacity:.5;cursor:not-allowed}
.fb-thanks{font-size:13px;color:var(--accent)}

/* â”€â”€ Mobile â”€â”€ */
@media(max-width:768px){
  .sidebar{position:fixed;left:0;top:0;height:100vh;z-index:200;box-shadow:0 0 30px rgba(0,0,0,.5)}
  .sidebar.collapsed{margin-left:calc(var(--sidebar-w)*-1)}
  .mobile-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:199}
  .mobile-overlay.open{display:block}
  .topbar-kbd{display:none}
  .messages{padding:16px 12px}
  .input-area{padding:10px 12px}
  .welcome-cards{grid-template-columns:repeat(2,1fr)}
  .idea-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- Mobile overlay -->
<div class="mobile-overlay" id="mobileOverlay"></div>

<!-- Sidebar -->
<aside class="sidebar collapsed" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo">ğŸŒ…</div>
    <div>
      <div class="sidebar-title">ë¼ì˜¨ AI ë¹„ì„œ</div>
      <div class="sidebar-subtitle">ìŠ¤íƒ€íŠ¸ì—… ì„±ì¥ íŒŒíŠ¸ë„ˆ</div>
    </div>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-label">ëª¨ë“œ</div>
    <button class="mode-btn active" data-mode="idea"><span class="mode-icon">ğŸš€</span>ì•„ì´ë””ì–´</button>
    <button class="mode-btn" data-mode="draft"><span class="mode-icon">âœï¸</span>ì´ˆì•ˆ ì‘ì„±</button>
    <button class="mode-btn" data-mode="evaluate"><span class="mode-icon">ğŸ“Š</span>ì‚¬ì—… í‰ê°€</button>
    <button class="mode-btn" data-mode="improve"><span class="mode-icon">ğŸ’¡</span>ê°œì„  ì œì•ˆ</button>
    <button class="mode-btn" data-mode="match"><span class="mode-icon">ğŸ¯</span>ì •ë¶€ì‚¬ì—… ë§¤ì¹­</button>
    <button class="mode-btn" data-mode="checklist"><span class="mode-icon">âœ…</span>ì²´í¬ë¦¬ìŠ¤íŠ¸</button>
  </div>

  <div class="sidebar-divider"></div>

  <div class="sidebar-section" style="flex-shrink:0">
    <div class="sidebar-label">ğŸ“‚ ì´ì „ ëŒ€í™”</div>
  </div>
  <div class="history-section" id="historyList">
    <div class="history-empty">ì•„ì§ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
  </div>

  <div class="profile-card" id="profileCard">
    <div class="profile-top">
      <span class="profile-title" id="profileTitle">ğŸŒ± ì˜ˆë¹„ì°½ì—…ì</span>
      <span class="profile-level" id="profileLevel">Lv.1</span>
    </div>
    <div class="xp-bar"><div class="xp-fill" id="xpFill" style="width:0%"></div></div>
    <div class="profile-xp-text" id="xpText">0 / 100 XP</div>
    <div class="profile-badges" id="profileBadges"></div>
  </div>
</aside>

<!-- Main -->
<div class="main">
  <div class="topbar">
    <button class="topbar-toggle" id="sidebarToggle">â˜°</button>
    <div class="topbar-mode" id="topbarMode">ğŸš€ ì•„ì´ë””ì–´</div>
    <button class="topbar-new" id="newChatBtn">
      <span>+ ìƒˆ ëŒ€í™”</span>
      <span class="topbar-kbd">âŒ˜N</span>
    </button>
  </div>

  <div class="messages" id="messagesArea">
    <div class="messages-inner" id="messagesInner">
      <div class="welcome" id="welcomeScreen">
        <div class="welcome-emoji">ğŸŒ…</div>
        <h2>ë¼ì˜¨ AI ë¹„ì„œ</h2>
        <p>YC Â· a16z ê¸°ë°˜ ì•„ì´ë””ì–´ ì¶”ì²œë¶€í„° ì‚¬ì—…ê³„íšì„œ í‰ê°€, ì •ë¶€ì‚¬ì—… ë§¤ì¹­ê¹Œì§€</p>
        <div class="welcome-cards">
          <div class="welcome-card" data-mode="idea"><div class="wc-icon">ğŸš€</div><div class="wc-title">ì•„ì´ë””ì–´ íƒìƒ‰</div><div class="wc-desc">YCÂ·a16z íŠ¸ë Œë“œ ê¸°ë°˜ ì¶”ì²œ</div></div>
          <div class="welcome-card" data-mode="evaluate"><div class="wc-icon">ğŸ“Š</div><div class="wc-title">ì‚¬ì—… í‰ê°€</div><div class="wc-desc">TIPS ê¸°ì¤€ 100ì  í‰ê°€</div></div>
          <div class="welcome-card" data-mode="draft"><div class="wc-icon">âœï¸</div><div class="wc-title">ì´ˆì•ˆ ì‘ì„±</div><div class="wc-desc">ì§€ì›ì„œ ì´ˆì•ˆ ìë™ ìƒì„±</div></div>
          <div class="welcome-card" data-mode="match"><div class="wc-icon">ğŸ¯</div><div class="wc-title">ì •ë¶€ì‚¬ì—… ë§¤ì¹­</div><div class="wc-desc">508ê°œ ì‚¬ì—… ìë™ ë§¤ì¹­</div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="input-area">
    <div class="input-inner">
      <div class="file-badge" id="fileBadge">
        ğŸ“„ <span id="fileName"></span>
        <button id="fileClear">âœ•</button>
      </div>
      <div class="drop-zone" id="dropZone">ğŸ“„ PDF íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”</div>
      <div class="input-row">
        <div class="input-wrap">
          <textarea id="chatInput" rows="1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (Shift+Enter: ì¤„ë°”ê¿ˆ)"></textarea>
          <div class="input-btns">
            <input type="file" id="fileInput" accept=".pdf" style="display:none">
            <button class="pdf-btn" id="pdfBtn" title="PDF ì—…ë¡œë“œ">ğŸ“</button>
          </div>
        </div>
        <button class="send-btn" id="sendBtn">â†‘</button>
      </div>
    </div>
  </div>
</div>

<!-- Cmd+K modal -->
<div class="cmd-modal-overlay" id="cmdModal">
  <div class="cmd-modal">
    <div class="cmd-modal-header">ëª¨ë“œ ì „í™˜ <span class="topbar-kbd">âŒ˜K</span></div>
    <button class="mode-btn" data-mode="idea"><span class="mode-icon">ğŸš€</span>ì•„ì´ë””ì–´</button>
    <button class="mode-btn" data-mode="draft"><span class="mode-icon">âœï¸</span>ì´ˆì•ˆ ì‘ì„±</button>
    <button class="mode-btn" data-mode="evaluate"><span class="mode-icon">ğŸ“Š</span>ì‚¬ì—… í‰ê°€</button>
    <button class="mode-btn" data-mode="improve"><span class="mode-icon">ğŸ’¡</span>ê°œì„  ì œì•ˆ</button>
    <button class="mode-btn" data-mode="match"><span class="mode-icon">ğŸ¯</span>ì •ë¶€ì‚¬ì—… ë§¤ì¹­</button>
    <button class="mode-btn" data-mode="checklist"><span class="mode-icon">âœ…</span>ì²´í¬ë¦¬ìŠ¤íŠ¸</button>
  </div>
</div>

<script>
(function(){
'use strict';

const API_URL = window.RAON_API_URL || '';
const MODE_NAMES = {
  idea:'ğŸš€ ì•„ì´ë””ì–´', draft:'âœï¸ ì´ˆì•ˆ ì‘ì„±', evaluate:'ğŸ“Š ì‚¬ì—… í‰ê°€',
  improve:'ğŸ’¡ ê°œì„  ì œì•ˆ', match:'ğŸ¯ ì •ë¶€ì‚¬ì—… ë§¤ì¹­', checklist:'âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸'
};
const MODE_PLACEHOLDERS = {
  idea:'ê´€ì‹¬ ë¶„ì•¼ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ "ì „ì²´"ë¡œ ëª©ë¡ í™•ì¸',
  draft:'ì‚¬ì—… ì•„ì´ë””ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
  evaluate:'ì‚¬ì—…ê³„íšì„œë¥¼ ì…ë ¥í•˜ê±°ë‚˜ PDFë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”',
  improve:'ê°œì„ í•  ì‚¬ì—…ê³„íšì„œë¥¼ ì…ë ¥í•˜ì„¸ìš”',
  match:'ì‚¬ì—… ë‚´ìš©ì„ ì…ë ¥í•˜ë©´ ì •ë¶€ì‚¬ì—…ì„ ë§¤ì¹­í•©ë‹ˆë‹¤',
  checklist:'ì§€ì› ì¤€ë¹„ ìƒíƒœë¥¼ ì ê²€í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”',
};

let currentMode = 'idea';
let pendingPdfBase64 = null;
let sessionContext = {}; // {lastDraft, lastIdea, lastEvaluation}
let currentConvId = null;
let conversations = JSON.parse(localStorage.getItem('raon_convs') || '{}');

// DOM
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const sidebar = $('#sidebar');
const sidebarToggle = $('#sidebarToggle');
const mobileOverlay = $('#mobileOverlay');
const messagesArea = $('#messagesArea');
const messagesInner = $('#messagesInner');
const welcomeScreen = $('#welcomeScreen');
const chatInput = $('#chatInput');
const sendBtn = $('#sendBtn');
const fileInput = $('#fileInput');
const pdfBtn = $('#pdfBtn');
const fileBadge = $('#fileBadge');
const fileName = $('#fileName');
const fileClear = $('#fileClear');
const topbarMode = $('#topbarMode');
const newChatBtn = $('#newChatBtn');
const cmdModal = $('#cmdModal');
const dropZone = $('#dropZone');
const historyList = $('#historyList');

// â”€â”€ Sidebar toggle â”€â”€
function toggleSidebar(show) {
  const shouldShow = show !== undefined ? show : sidebar.classList.contains('collapsed');
  sidebar.classList.toggle('collapsed', !shouldShow);
  mobileOverlay.classList.toggle('open', shouldShow && window.innerWidth <= 768);
}
sidebarToggle.addEventListener('click', () => toggleSidebar());
mobileOverlay.addEventListener('click', () => toggleSidebar(false));

// Auto-open sidebar on desktop
if (window.innerWidth > 768) toggleSidebar(true);

// â”€â”€ Mode switching â”€â”€
function setMode(mode) {
  currentMode = mode;
  $$('.mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
  topbarMode.textContent = MODE_NAMES[mode] || mode;
  chatInput.placeholder = MODE_PLACEHOLDERS[mode] || 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
  // Close cmd modal + mobile sidebar
  cmdModal.classList.remove('open');
  if (window.innerWidth <= 768) toggleSidebar(false);
  // Show mode guide message
  const guides = {
    idea: 'ğŸš€ <strong>ì•„ì´ë””ì–´ ëª¨ë“œ</strong><br>ì „ì†¡ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ YCÂ·a16z ê¸°ë°˜ 62ê°œ ì•„ì´ë””ì–´ë¥¼ íƒìƒ‰í•  ìˆ˜ ìˆì–´ìš”.<br>ê´€ì‹¬ ë¶„ì•¼ë¥¼ ì…ë ¥í•˜ë©´ ë§ì¶¤ ì¶”ì²œë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.',
    evaluate: 'ğŸ“Š <strong>í‰ê°€ ëª¨ë“œ</strong><br>ì‚¬ì—… ì•„ì´ë””ì–´ë‚˜ ê³„íšì„œë¥¼ ì…ë ¥í•˜ë©´ TIPS ì‹¬ì‚¬ ê¸°ì¤€ìœ¼ë¡œ 100ì  ë§Œì  í‰ê°€í•´ë“œë ¤ìš”.<br>PDF íŒŒì¼ë„ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.',
    draft: 'âœï¸ <strong>ì´ˆì•ˆ ì‘ì„± ëª¨ë“œ</strong><br>ì‚¬ì—… ì•„ì´ë””ì–´ë¥¼ ì…ë ¥í•˜ë©´ ì •ë¶€ì§€ì›ì‚¬ì—… ì§€ì›ì„œ ì´ˆì•ˆì„ ìë™ ìƒì„±í•´ë“œë ¤ìš”.',
    improve: 'ğŸ’¡ <strong>ê°œì„  ëª¨ë“œ</strong><br>ê¸°ì¡´ ì‚¬ì—…ê³„íšì„œë¥¼ ì…ë ¥í•˜ë©´ êµ¬ì²´ì ì¸ ê°œì„ ì ì„ ì œì•ˆí•´ë“œë ¤ìš”.',
    match: 'ğŸ¯ <strong>ë§¤ì¹­ ëª¨ë“œ</strong><br>ì‚¬ì—… ë‚´ìš©ì„ ì…ë ¥í•˜ë©´ ì í•©í•œ ì •ë¶€ì§€ì›ì‚¬ì—…ì„ ì¶”ì²œí•´ë“œë ¤ìš”.',
    checklist: 'âœ… <strong>ì²´í¬ë¦¬ìŠ¤íŠ¸ ëª¨ë“œ</strong><br>ì§€ì›ì„œ ì œì¶œ ì „ ë¹ ì§„ í•­ëª©ì´ ì—†ëŠ”ì§€ ì ê²€í•´ë“œë ¤ìš”.'
  };
  if (guides[mode] && welcomeScreen.style.display === 'none') {
    addMsg(guides[mode], 'bot');
  }
}

$$('.mode-btn').forEach(btn => {
  btn.addEventListener('click', () => setMode(btn.dataset.mode));
});

// Welcome cards
$$('.welcome-card').forEach(card => {
  card.addEventListener('click', () => {
    setMode(card.dataset.mode);
    welcomeScreen.style.display = 'none';
  });
});

// â”€â”€ Cmd+K modal â”€â”€
document.addEventListener('keydown', e => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    cmdModal.classList.toggle('open');
  }
  if (e.key === 'Escape') cmdModal.classList.remove('open');
  if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
    e.preventDefault();
    newChat();
  }
});
cmdModal.addEventListener('click', e => { if (e.target === cmdModal) cmdModal.classList.remove('open'); });

// â”€â”€ File handling â”€â”€
pdfBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', handleFileSelect);
fileClear.addEventListener('click', clearFile);

function handleFileSelect() {
  const file = fileInput.files[0];
  if (!file) return;
  if (file.size > 10*1024*1024) { addMsg('âš ï¸ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (ìµœëŒ€ 10MB)', 'bot'); fileInput.value=''; return; }
  const reader = new FileReader();
  reader.onload = () => {
    pendingPdfBase64 = reader.result.split(',')[1];
    fileName.textContent = file.name;
    fileBadge.classList.add('visible');
    pdfBtn.classList.add('has-file');
  };
  reader.readAsDataURL(file);
}
function clearFile() {
  pendingPdfBase64 = null; fileInput.value = '';
  fileBadge.classList.remove('visible'); pdfBtn.classList.remove('has-file');
}

// Drag & drop
['dragenter','dragover'].forEach(ev => {
  document.addEventListener(ev, e => { e.preventDefault(); dropZone.classList.add('active'); });
});
['dragleave','drop'].forEach(ev => {
  document.addEventListener(ev, e => { e.preventDefault(); dropZone.classList.remove('active'); });
});
document.addEventListener('drop', e => {
  const file = e.dataTransfer.files[0];
  if (file && file.type === 'application/pdf') {
    const dt = new DataTransfer(); dt.items.add(file);
    fileInput.files = dt.files;
    handleFileSelect();
  }
});

// â”€â”€ Textarea auto-resize â”€â”€
chatInput.addEventListener('input', () => {
  chatInput.style.height = 'auto';
  chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
});

// â”€â”€ Send â”€â”€
let isComposing = false;
chatInput.addEventListener('compositionstart', () => { isComposing = true; });
chatInput.addEventListener('compositionend', () => { isComposing = false; });
chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey && !isComposing) { e.preventDefault(); sendMessage(); }
});
sendBtn.addEventListener('click', sendMessage);
newChatBtn.addEventListener('click', newChat);

function newChat() {
  saveCurrentConv();
  currentConvId = null;
  sessionContext = {};
  messagesInner.innerHTML = '';
  welcomeScreen.style.display = '';
  messagesInner.appendChild(welcomeScreen);
  chatInput.value = '';
  chatInput.style.height = 'auto';
}

// â”€â”€ Messages â”€â”€
function addMsg(html, type, extra) {
  welcomeScreen.style.display = 'none';
  const div = document.createElement('div');
  div.className = `msg msg-${type}`;
  if (type === 'bot') {
    div.innerHTML = `<div class="msg-avatar">ğŸŒ…</div><div class="msg-content">${html}</div>`;
  } else {
    div.innerHTML = `<div class="msg-content">${html}</div>`;
  }
  if (extra) div.dataset.extra = extra;
  messagesInner.appendChild(div);
  messagesArea.scrollTop = messagesArea.scrollHeight;
  return div;
}

// â”€â”€ Markdown renderer â”€â”€
function renderMarkdown(raw) {
  const lines = raw.split('\n');
  let out = [], inTable = false, tableHtml = '';
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    if (line.startsWith('|') && line.endsWith('|')) {
      const cells = line.split('|').slice(1,-1).map(c=>c.trim());
      if (cells.every(c => /^[-:]+$/.test(c))) continue;
      if (!inTable) {
        inTable = true;
        tableHtml = '<table><tr>' + cells.map(c=>'<th>'+boldify(c)+'</th>').join('') + '</tr>';
      } else {
        tableHtml += '<tr>' + cells.map(c=>'<td>'+boldify(c)+'</td>').join('') + '</tr>';
      }
    } else {
      if (inTable) { out.push(tableHtml+'</table>'); inTable=false; tableHtml=''; }
      out.push(line);
    }
  }
  if (inTable) out.push(tableHtml+'</table>');
  return out.join('\n')
    .replace(/^### (.+)/gm,'<h3>$1</h3>')
    .replace(/^## (.+)/gm,'<h2>$1</h2>')
    .replace(/^# (.+)/gm,'<h1>$1</h1>')
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.*?)\*/g,'<em>$1</em>')
    .replace(/`([^`]+)`/g,'<code>$1</code>')
    .replace(/^- (.+)/gm,'<li>$1</li>')
    .replace(/(<li>.*<\/li>\n?)+/g, m => '<ul>'+m+'</ul>')
    .replace(/\n/g,'<br>');
}
function boldify(s){ return s.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>'); }

// â”€â”€ Loading UX â”€â”€
const tips = [
  'ğŸ’¡ TIPS ìš´ì˜ì‚¬ëŠ” AC/VC 60+ê°œì‚¬ê°€ ì°¸ì—¬í•´ìš”',
  'ğŸ’¡ 2026ë…„ ì°½ì—…ì§€ì›ì‚¬ì—… ì´ ì˜ˆì‚°: 3.46ì¡°ì›!',
  'ğŸ’¡ ì‚¬ì—…ê³„íšì„œì— ì •ëŸ‰ ìˆ˜ì¹˜ê°€ ìˆìœ¼ë©´ í•©ê²©ë¥  2ë°°â†‘',
  'ğŸ’¡ TAM-SAM-SOM í”„ë ˆì„ì›Œí¬ë¡œ ì‹œì¥ ê·œëª¨ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”',
  'ğŸ’¡ TIPS ìµœëŒ€ 8ì–µì› (2026ë…„ ê¸°ì¤€)',
  'ğŸ’¡ ê³ ê° PoC/LOIê°€ ìˆìœ¼ë©´ ì‹¬ì‚¬ì—ì„œ ì••ë„ì  ìœ ë¦¬!',
  'ğŸ’¡ 520x ê°™ì€ íš¨ìœ¨ ìˆ˜ì¹˜ëŠ” ê°•ë ¥í•œ ì°¨ë³„í™” í¬ì¸íŠ¸',
  'ğŸ’¡ 2026ë…„ 508ê°œ ì •ë¶€ ì°½ì—…ì§€ì›ì‚¬ì—…ì´ ìš´ì˜ ì¤‘',
];
const modeStages = {
  evaluate:['ğŸ“„ ì‚¬ì—…ê³„íšì„œ ì½ëŠ” ì¤‘','ğŸ” í•µì‹¬ ì§€í‘œ ë¶„ì„ ì¤‘','ğŸ“Š TIPS ì‹¬ì‚¬ê¸°ì¤€ ëŒ€ì¡° ì¤‘','ğŸ›ï¸ ì •ë¶€ì‚¬ì—… ë§¤ì¹­ ì¤‘','âœï¸ ê²°ê³¼ ì •ë¦¬ ì¤‘'],
  improve:['ğŸ“„ ì‚¬ì—…ê³„íšì„œ ë¶„ì„ ì¤‘','ğŸ” ì•½ì  íŒŒì•… ì¤‘','ğŸ’¡ ê°œì„ ì•ˆ ìƒì„± ì¤‘','âœï¸ ê²°ê³¼ ì •ë¦¬ ì¤‘'],
  match:['ğŸ“„ ì‚¬ì—… ë‚´ìš© ë¶„ì„ ì¤‘','ğŸ›ï¸ 508ê°œ ì •ë¶€ì‚¬ì—… ê²€ìƒ‰ ì¤‘','ğŸ¯ ì í•©ë„ ë§¤ì¹­ ì¤‘','âœï¸ ê²°ê³¼ ì •ë¦¬ ì¤‘'],
  draft:['ğŸ“„ ì•„ì´ë””ì–´ ë¶„ì„ ì¤‘','ğŸ›ï¸ ì§€ì›ì‚¬ì—… ìš”ê±´ í™•ì¸ ì¤‘','âœï¸ ì§€ì›ì„œ ì´ˆì•ˆ ì‘ì„± ì¤‘','ğŸ“ í•­ëª©ë³„ ë‚´ìš© ì±„ìš°ëŠ” ì¤‘','ğŸ” ìµœì¢… ê²€í†  ì¤‘'],
  checklist:['ğŸ“„ ì‚¬ì—… ìš”ê±´ í™•ì¸ ì¤‘','âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„± ì¤‘','âœï¸ ê²°ê³¼ ì •ë¦¬ ì¤‘'],
};

function createLoading(mode) {
  const stages = modeStages[mode] || ['â³ ì²˜ë¦¬ ì¤‘'];
  const el = addMsg(`<div class="loading-inner"><div class="spinner"></div><span>${stages[0]}...</span></div>`, 'bot');
  el.classList.add('msg-loading');
  const start = Date.now();
  let stageIdx = 0, tipIdx = 0;
  const timer = setInterval(() => {
    const elapsed = Math.round((Date.now()-start)/1000);
    stageIdx++;
    const pct = Math.min(95, (stageIdx/(stages.length+2))*100);
    const content = el.querySelector('.msg-content');
    if (stageIdx < stages.length) {
      content.innerHTML = `<div class="loading-inner"><div class="spinner"></div><span>${stages[stageIdx]}...</span></div><div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div><div class="loading-elapsed">â± ${elapsed}ì´ˆ ê²½ê³¼</div>`;
    } else {
      const tip = tips[tipIdx++ % tips.length];
      content.innerHTML = `<div class="loading-inner"><div class="spinner"></div><span>AIê°€ ì—´ì‹¬íˆ ì‘ì„± ì¤‘...</span></div><div class="progress-bar"><div class="progress-fill" style="width:${Math.min(95,70+tipIdx*3)}%"></div></div><div class="loading-tip">${tip}</div><div class="loading-elapsed">â± ${elapsed}ì´ˆ ê²½ê³¼ â€” ë¬¸ì„œ ê¸¸ì´ì— ë”°ë¼ ìˆ˜ ë¶„ ì†Œìš”</div>`;
    }
    messagesArea.scrollTop = messagesArea.scrollHeight;
  }, 3000);
  return { el, timer };
}

// â”€â”€ XP display â”€â”€
const levelThresholds = [0,100,300,600,1000,1500,2500,5000];
function updateProfileCard(profile) {
  if (!profile) return;
  const lvl = profile.level || 1;
  const title = profile.title || 'ğŸŒ± ì˜ˆë¹„ì°½ì—…ì';
  const xp = profile.xp || 0;
  const badges = profile.badges || [];
  const cur = levelThresholds[Math.min(lvl-1, levelThresholds.length-1)] || 0;
  const next = levelThresholds[Math.min(lvl, levelThresholds.length-1)] || (cur+100);
  const inLevel = xp - cur;
  const needed = next - cur;
  const pct = Math.min(100, Math.round(inLevel/needed*100));

  $('#profileTitle').textContent = title;
  $('#profileLevel').textContent = 'Lv.' + lvl;
  $('#xpFill').style.width = pct + '%';
  $('#xpText').textContent = `${inLevel} / ${needed} XP`;
  const badgesEl = $('#profileBadges');
  badgesEl.innerHTML = badges.map(b => `<span class="profile-badge" title="${b}">${b}</span>`).join('');
}

async function fetchProfile() {
  try {
    const r = await fetch(API_URL+'/v1/profile');
    const d = await r.json();
    if (d.status==='ok' && d.profile) updateProfileCard(d.profile);
  } catch(e){}
}
fetchProfile();

function buildXpHtml(data, profile) {
  if (!data.xp_gained) return '';
  const lvl = profile?.level || data.level || 1;
  const title = profile?.title || data.title || 'ğŸŒ± ì˜ˆë¹„ì°½ì—…ì';
  const xp = profile?.xp || 0;
  const cur = levelThresholds[Math.min(lvl-1,levelThresholds.length-1)]||0;
  const next = levelThresholds[Math.min(lvl,levelThresholds.length-1)]||(cur+100);
  const inLevel = xp-cur, needed = next-cur;
  const pct = Math.min(100, Math.round(inLevel/needed*100));
  let html = `<div class="xp-inline"><div style="display:flex;justify-content:space-between"><span>${title} Lv.${lvl}</span><span style="color:var(--accent)">+${data.xp_gained} XP</span></div><div class="xp-bar-inline"><div class="xp-fill-inline" style="width:${pct}%"></div></div><div style="text-align:right;color:var(--text3);font-size:10px;margin-top:2px">${inLevel}/${needed} XP</div>`;
  if (data.new_badges?.length) html += `<div style="margin-top:4px;color:var(--accent2)">ğŸ† ìƒˆ ë±ƒì§€: ${data.new_badges.join(', ')}</div>`;
  html += '</div>';
  return html;
}

// â”€â”€ Send message â”€â”€
let _lastRequest = {};
function retryLast() {
  if (_lastRequest.text) chatInput.value = _lastRequest.text;
  if (_lastRequest.pdf) pendingPdfBase64 = _lastRequest.pdf;
  if (_lastRequest.mode) setMode(_lastRequest.mode);
  sendMessage();
}
async function sendMessage() {
  const text = chatInput.value.trim();
  if (!text && !pendingPdfBase64 && currentMode !== 'idea') return;
  _lastRequest = { text, pdf: pendingPdfBase64, mode: currentMode };

  const displayText = pendingPdfBase64
    ? `ğŸ“„ ${fileName.textContent}${text?' â€” '+text:''}`
    : text;
  if (displayText) addMsg(displayText, 'user');
  chatInput.value = '';
  chatInput.style.height = 'auto';
  sendBtn.disabled = true;

  // Ensure conversation id
  if (!currentConvId) {
    currentConvId = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
  }

  // â”€â”€ Idea mode â”€â”€
  if (currentMode === 'idea') {
    try {
      let res, data;
      if (!text || text.length < 2) {
        res = await fetch(`${API_URL}/v1/idea/list`);
        data = await res.json();
        if (data.status === 'ok') {
          const cats = data.categories || [];
          let html = `<h2>YC Â· a16z ì•„ì´ë””ì–´ ëª©ë¡ (${cats.length}ê°œ)</h2><div class="idea-grid">`;
          cats.forEach(c => {
            html += `<div class="idea-card" onclick="window._raonViewIdea(${c.id})">
              <div class="ic-num">#${c.id}</div>
              <div class="ic-name">${c.name}</div>
              <div class="ic-desc">${c.subtitle||c.description||''}</div>
              <div class="ic-source">${c.source||''}</div>
            </div>`;
          });
          html += '</div><p style="color:var(--text2);font-size:13px;margin-top:8px">ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ ì„¤ëª…ì„ ë³¼ ìˆ˜ ìˆì–´ìš”!</p>';
          addMsg(html, 'bot');
        } else {
          addMsg('âš ï¸ '+(data.error||'ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'), 'bot');
        }
      } else if (/^\d+$/.test(text.trim())) {
        await showIdeaDetail(text.trim());
      } else {
        const loading = createLoading('idea');
        res = await fetch(`${API_URL}/v1/idea/suggest`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({background:text,interests:text})
        });
        data = await res.json();
        clearInterval(loading.timer); loading.el.remove();
        if (data.status === 'ok') {
          const items = data.suggestions || data.matches || [];
          let html = '<h2>ğŸ’¡ ë§ì¶¤ ì•„ì´ë””ì–´ ì¶”ì²œ</h2><div class="idea-grid">';
          items.forEach((s,i) => {
            const desc = s.reason||s.why_now||s.description||s.subtitle||'';
            const sName = (s.name||'').replace(/'/g,"\\'");
            const sDesc = (s.subtitle||desc||'').replace(/'/g,"\\'").substring(0,200);
            html += `<div class="idea-card">
              <div class="ic-num">#${i+1}</div>
              <div class="ic-name">${s.name}</div>
              <div class="ic-desc">${desc}</div>
              <div class="ic-source">${s.source||''}</div>
              <div class="idea-actions">
                <button class="idea-action-btn" style="background:#FF6B35" onclick="window._raonIdeaAction('evaluate','${sName}','${sDesc}')">ğŸ“Š í‰ê°€</button>
                <button class="idea-action-btn" style="background:#6366f1" onclick="window._raonIdeaAction('match','${sName}','${sDesc}')">ğŸ¯ ë§¤ì¹­</button>
                <button class="idea-action-btn" style="background:#f59e0b" onclick="window._raonIdeaAction('draft','${sName}','${sDesc}')">âœï¸ ì´ˆì•ˆ</button>
              </div>
            </div>`;
          });
          html += '</div>';
          if (!items.length) html = '<p>ë§¤ì¹­ë˜ëŠ” ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ì‹œë„í•´ë³´ì„¸ìš”!</p>';
          addMsg(html, 'bot');
        } else {
          addMsg('âš ï¸ '+(data.error||'ì¶”ì²œì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'), 'bot');
        }
      }
    } catch(e) {
      addMsg('âš ï¸ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. <button onclick="sendMessage()" style="margin-left:8px;padding:4px 14px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;">ğŸ”„ ì¬ì‹œë„</button>', 'bot');
    }
    sendBtn.disabled = false;
    chatInput.focus();
    saveCurrentConv();
    return;
  }

  // â”€â”€ Other modes â”€â”€
  const loading = createLoading(currentMode);
  const payload = { model: 'qwen3:8b' };

  if ((currentMode === 'draft' || currentMode === 'checklist') && window._raonPendingProgram) {
    payload.program = window._raonPendingProgram;
    window._raonPendingProgram = null;
  }

  // ê°œì„  ì œì•ˆ ëª¨ë“œ: ì´ì „ í‰ê°€ ê²°ê³¼ë¥¼ contextë¡œ ì „ë‹¬
  if (currentMode === 'improve' && sessionContext.lastEvaluation) {
    payload.context = sessionContext.lastEvaluation;
  }
  // ì´ˆì•ˆ ì‘ì„± ëª¨ë“œ: ì´ì „ ì•„ì´ë””ì–´ë¥¼ contextë¡œ ì „ë‹¬
  if (currentMode === 'draft' && sessionContext.lastIdea) {
    payload.context = JSON.stringify(sessionContext.lastIdea);
  }

  if (pendingPdfBase64) {
    payload.pdf_base64 = pendingPdfBase64;
    if (text) payload.text = text;
    clearFile();
  } else {
    payload.text = text;
  }

  try {
    const res = await fetch(`${API_URL}/v1/${currentMode}`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    clearInterval(loading.timer); loading.el.remove();

    if (data.status === 'ok') {
      const result = renderMarkdown(data.result || data.response || '');
      const scoreHtml = data.score ? `<div class="score-display">ğŸ“Š ${data.score}ì </div>` : '';

      // Store session context
      if (currentMode === 'draft') sessionContext.lastDraft = data.result;
      if (currentMode === 'evaluate') sessionContext.lastEvaluation = data.result;

      // Fetch profile for XP
      let profile = null;
      try {
        const pr = await fetch(API_URL+'/v1/profile');
        const pd = await pr.json();
        if (pd.status==='ok') { profile = pd.profile; updateProfileCard(profile); }
      } catch(e){}

      const xpHtml = buildXpHtml(data, profile);
      const msgEl = addMsg(scoreHtml + result + xpHtml, 'bot');

      // â”€â”€ í”¼ë“œë°± ë²„íŠ¼ (evaluate / improve ëª¨ë“œë§Œ í‘œì‹œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if ((currentMode === 'evaluate' || currentMode === 'improve') && data.evaluation_id) {
        const evalId = data.evaluation_id;
        const fbBar = document.createElement('div');
        fbBar.className = 'feedback-bar';
        fbBar.innerHTML =
          '<span class="feedback-label">ì´ í‰ê°€ê°€ ë„ì›€ì´ ëë‚˜ìš”?</span>' +
          '<button class="fb-btn" data-rating="1">ğŸ‘ ë„ì›€ëì–´ìš”</button>' +
          '<button class="fb-btn" data-rating="-1">ğŸ‘ ì•„ë‹ˆì—ìš”</button>';
        msgEl.querySelector('.msg-content').appendChild(fbBar);

        fbBar.querySelectorAll('.fb-btn').forEach(function(btn) {
          btn.addEventListener('click', async function() {
            const rating = parseInt(this.dataset.rating);
            // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸ (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
            fbBar.querySelectorAll('.fb-btn').forEach(function(b) { b.disabled = true; });
            fbBar.innerHTML = '<span class="fb-thanks">ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ™</span>';
            try {
              await fetch((API_URL || '') + '/v1/feedback', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({evaluation_id: evalId, rating: rating})
              });
            } catch(e) { /* UIëŠ” ì´ë¯¸ ì—…ë°ì´íŠ¸ë¨ â€” ë¬´ì‹œ */ }
          });
        });
      }
    } else {
      addMsg(`âš ï¸ ${data.error||'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}`, 'bot');
    }
  } catch(e) {
    clearInterval(loading.timer); loading.el.remove();
    addMsg('âš ï¸ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. <button onclick="sendMessage()" style="margin-left:8px;padding:4px 14px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;">ğŸ”„ ì¬ì‹œë„</button>', 'bot');
  }
  sendBtn.disabled = false;
  chatInput.focus();
  saveCurrentConv();
}

// â”€â”€ Idea detail â”€â”€
async function showIdeaDetail(id) {
  try {
    const res = await fetch(`${API_URL}/v1/idea/detail/${id}`);
    const data = await res.json();
    if (data.status === 'ok') {
      const d = data.category || data.detail || data;
      sessionContext.lastIdea = d;
      const ideaName = (d.name||'').replace(/'/g,"\\'");
      const ideaDesc = (d.description||d.subtitle||'').replace(/'/g,"\\'").substring(0,200);
      let html = `<h2>ğŸš€ [${d.id||id}] ${d.name||''}</h2>`;
      if (d.subtitle) html += `<p style="color:var(--text2);margin-bottom:12px">${d.subtitle}</p>`;
      if (d.description) html += `<h3>ğŸ“‹ ì„¤ëª…</h3><p>${d.description.replace(/\n/g,'<br>')}</p>`;
      if (d.why_now) html += `<h3>â° ì™œ ì§€ê¸ˆ</h3><p>${d.why_now.replace(/\n/g,'<br>')}</p>`;
      if (d.founder_profile) html += `<h3>ğŸ‘¤ ì í•©í•œ ì°½ì—…ì</h3><p>${d.founder_profile}</p>`;
      if (d.korea_market) html += `<h3>ğŸ‡°ğŸ‡· í•œêµ­ ì‹œì¥</h3><p>${d.korea_market.replace(/\n/g,'<br>')}</p>`;
      html += `<div class="idea-actions" style="margin-top:16px">
        <button class="idea-action-btn" style="background:#FF6B35" onclick="window._raonIdeaAction('evaluate','${ideaName}','${ideaDesc}')">ğŸ“Š ì´ê±¸ë¡œ í‰ê°€ë°›ê¸°</button>
        <button class="idea-action-btn" style="background:#10b981" onclick="window._raonIdeaAction('improve','${ideaName}','${ideaDesc}')">ğŸ’¡ ì‚¬ì—…ê³„íšì„œ ê°œì„ </button>
        <button class="idea-action-btn" style="background:#6366f1" onclick="window._raonIdeaAction('match','${ideaName}','${ideaDesc}')">ğŸ¯ ì •ë¶€ì‚¬ì—… ë§¤ì¹­</button>
        <button class="idea-action-btn" style="background:#f59e0b" onclick="window._raonIdeaAction('draft','${ideaName}','${ideaDesc}')">âœï¸ ì§€ì›ì„œ ì´ˆì•ˆ</button>
      </div>`;
      addMsg(html, 'bot');
    } else {
      addMsg('âš ï¸ '+(data.error||'ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'), 'bot');
    }
  } catch(e) {
    addMsg('âš ï¸ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. <button onclick="sendMessage()" style="margin-left:8px;padding:4px 14px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;">ğŸ”„ ì¬ì‹œë„</button>', 'bot');
  }
}

window._raonViewIdea = id => showIdeaDetail(id);

// â”€â”€ Idea â†’ mode action â”€â”€
window._raonIdeaAction = function(mode, name, desc) {
  setMode(mode);
  if (mode === 'draft' || mode === 'checklist') window._raonPendingProgram = name;
  const prompt = '[ì•„ì´ë””ì–´: '+name+'] '+desc;
  chatInput.value = prompt;
  sendMessage();
};

// â”€â”€ Conversation history â”€â”€
function saveCurrentConv() {
  if (!currentConvId) return;
  const msgs = [];
  messagesInner.querySelectorAll('.msg').forEach(m => {
    if (m.classList.contains('msg-loading') || m === welcomeScreen) return;
    msgs.push({ type: m.classList.contains('msg-user')?'user':'bot', html: m.querySelector('.msg-content')?.innerHTML || '' });
  });
  if (msgs.length === 0) return;
  const firstUserMsg = msgs.find(m => m.type === 'user');
  const title = firstUserMsg ? firstUserMsg.html.replace(/<[^>]*>/g,'').substring(0,40) : 'ìƒˆ ëŒ€í™”';
  conversations[currentConvId] = { title, mode: currentMode, msgs, ts: Date.now() };
  // Keep max 30
  const keys = Object.keys(conversations).sort((a,b) => conversations[b].ts - conversations[a].ts);
  if (keys.length > 30) { keys.slice(30).forEach(k => delete conversations[k]); }
  localStorage.setItem('raon_convs', JSON.stringify(conversations));
  renderHistory();
}

function renderHistory() {
  const keys = Object.keys(conversations).sort((a,b) => conversations[b].ts - conversations[a].ts);
  if (!keys.length) { historyList.innerHTML = '<div class="history-empty">ì•„ì§ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
  historyList.innerHTML = keys.map(k => {
    const c = conversations[k];
    const icon = MODE_NAMES[c.mode]?.split(' ')[0] || 'ğŸ’¬';
    return `<div class="history-item" data-id="${k}">
      <span class="hi-icon">${icon}</span>
      <span class="hi-text">${c.title}</span>
      <button class="hi-del" data-del="${k}" title="ì‚­ì œ">âœ•</button>
    </div>`;
  }).join('');
  historyList.querySelectorAll('.history-item').forEach(item => {
    item.addEventListener('click', e => {
      if (e.target.dataset.del) {
        delete conversations[e.target.dataset.del];
        localStorage.setItem('raon_convs', JSON.stringify(conversations));
        renderHistory();
        return;
      }
      loadConversation(item.dataset.id);
    });
  });
}

function loadConversation(id) {
  const conv = conversations[id];
  if (!conv) return;
  currentConvId = id;
  setMode(conv.mode);
  messagesInner.innerHTML = '';
  welcomeScreen.style.display = 'none';
  conv.msgs.forEach(m => addMsg(m.html, m.type));
  if (window.innerWidth <= 768) toggleSidebar(false);
}

renderHistory();

})();
</script>
</body>
</html>
