import pytest
import responses
import socket
from scripts.scuttle import WebScuttler, ScuttleError, ScuttleConfig

@pytest.fixture
def scuttler():
    return WebScuttler()

@pytest.fixture
def config():
    return ScuttleConfig(allow_private_networks=False)

def test_block_localhost(scuttler, config):
    # Tests direct localhost hostname
    with pytest.raises(ScuttleError, match="Blocked host: 'localhost'"):
        scuttler.scuttle("http://localhost", config)

def test_block_ipv4_loopback(scuttler, config):
    # Tests loopback range 127.0.0.0/8
    with pytest.raises(ScuttleError, match="restricted IP: 127.0.0.1"):
        scuttler.scuttle("http://127.0.0.1", config)

def test_block_private_rfc1918(scuttler, config):
    # 10.0.0.0/8
    with pytest.raises(ScuttleError, match="restricted IP: 10.0.0.1"):
        scuttler.scuttle("http://10.0.0.1", config)
    # 172.16.0.0/12
    with pytest.raises(ScuttleError, match="restricted IP: 172.16.0.1"):
        scuttler.scuttle("http://172.16.0.1", config)
    # 192.168.0.0/16
    with pytest.raises(ScuttleError, match="restricted IP: 192.168.1.1"):
        scuttler.scuttle("http://192.168.1.1", config)

def test_block_link_local_metadata(scuttler, config):
    # Cloud metadata IP
    with pytest.raises(ScuttleError, match="restricted IP: 169.254.169.254"):
        scuttler.scuttle("http://169.254.169.254", config)

def test_block_ipv6_loopback(scuttler, config):
    with pytest.raises(ScuttleError, match="restricted IP: ::1"):
        scuttler.scuttle("http://[::1]", config)

def test_dns_rebinding_protection(scuttler, config, mocker):
    # Simulate a domain that resolves to a restricted IP
    mocker.patch("socket.getaddrinfo", return_value=[(None, None, None, None, ("127.0.0.1", 80))])
    with pytest.raises(ScuttleError, match="resolves to a restricted IP"):
        scuttler.scuttle("http://malicious-dns-rebind.com", config)

def test_allow_override(scuttler):
    # Ensures the --allow-private-networks flag works
    config_allow = ScuttleConfig(allow_private_networks=True)
    with responses.RequestsMock() as rsps:
        rsps.add(responses.GET, "http://127.0.0.1", body="<p>Local content</p>", status=200)
        result = scuttler.scuttle("http://127.0.0.1", config_allow)
        assert result["content"] == "Local content"

def test_block_non_http(scuttler, config):
    with pytest.raises(ScuttleError, match="Only http/https"):
        scuttler.scuttle("file:///etc/passwd", config)
